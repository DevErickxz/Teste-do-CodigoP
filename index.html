<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gr√°fico de Sujeira</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="auth.css">
  <style>
    /* Estilos para a statistics-view */
    #statistics-view .sides {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    #statistics-view .valvulas-list {
        display: grid;
        /* Altera para 2 fileiras de 6 */
        grid-template-columns: repeat(6, 1fr);
        gap: 15px;
        margin-top: 20px;
        padding: 0 1rem;
        /* Centraliza o grid */
        justify-items: center;
    }
    /* Media query para telas menores, para quebrar a linha */
    @media (max-width: 768px) {
        #statistics-view .valvulas-list {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Ajusta para telas menores */
        }
    }

    #statistics-view .valvula-item {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%; /* Garante que o item ocupe a largura da coluna */
        max-width: 150px; /* Limita a largura individual do item */
    }
    #statistics-view .valvula-item:hover {
        background-color: #e0e0e0;
    }
    #statistics-view .valvula-item.selected {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    #statistics-view .chart-container {
        margin-top: 30px;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        width: 90%; /* Aumenta a largura do container do gr√°fico */
        max-width: 900px; /* Limite m√°ximo para o gr√°fico */
        margin-left: auto; /* Centraliza */
        margin-right: auto; /* Centraliza */
    }
    #statistics-view h2 {
        text-align: center;
        margin-top: 20px;
        color: #333;
    }
    #statistics-view .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 1rem;
        background-color: #eee;
        border-bottom: 1px solid #ccc;
        flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
        gap: 10px; /* Espa√ßamento entre os itens da top bar */
    }
    #statistics-view .top-bar button,
    #statistics-view .top-bar select {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    #statistics-view .top-bar button:hover,
    #statistics-view .top-bar select:hover {
        background-color: #0056b3;
    }
    #statistics-view .side-btn {
        background-color: #e9ecef;
        color: #495057;
        border: 1px solid #ced4da;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #statistics-view .side-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    #graph-view .top-bar { /* Garante que o bot√£o da estat√≠stica apare√ßa corretamente aqui */
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    /* Novos estilos para os bot√µes de √°rea */
    .area-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .area-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #28a745; /* Cor para Raizer/Caixa */
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .area-button:hover {
        background-color: #218838;
    }
    .area-button.active {
        background-color: #196f3d;
        border: 2px solid #145c2f;
    }

    /* Estilo para ocultar o gr√°fico de barras inicialmente */
    #bar-chart-container {
        display: none;
    }
  </style>
</head>
<body>

  <div id="login-view" class="view active">
    <form class="auth-form" id="login-form">
      <h2>Login</h2>
      <input type="email" id="login-username" placeholder="E-mail" required>
      <input type="password" id="login-password" placeholder="Senha" required>
      <button type="submit">Entrar</button>
      <div class="switch">
        N√£o tem conta? <a href="#" id="to-register">Cadastre-se</a>
      </div>
      <button type="button" id="btn-google">Login com Google</button>
    </form>
  </div>

  <div id="register-view" class="view">
    <form class="auth-form" id="register-form">
      <h2>Cadastro</h2>
      <input type="text" id="reg-nome" placeholder="Nome Completo" required>
      <input type="email" id="reg-username" placeholder="E-mail" required>
      <input type="password" id="reg-password" placeholder="Senha" required>
      <button type="submit">Cadastrar</button>
      <div class="switch">
        J√° tem conta? <a href="#" id="to-login">Fa√ßa login</a>
      </div>
      <button type="button" id="btn-google-register">Cadastrar com Google</button>
    </form>
  </div>

  <div id="valve-view" class="view">
    <header class="valve-header">
      <button onclick="logout()">Sair</button>
      <button onclick="showGraphOptions()">Ver Gr√°fico de Barras</button>
    </header>

    <div id="inputs-pressao">
      <label for="input-usuario">Usu√°rio:</label>
      <input type="text" id="input-usuario" placeholder="Seu Nome" readonly>
      <label for="input-area">√Årea:</label>
      <input type="text" id="input-area" placeholder="Raizer" readonly> <label for="pressao-raizer">Press√£o Raizer (bar):</label>
      <input type="number" id="pressao-raizer" placeholder="Ex: 5.2" step="0.1">
      <label for="pressao-caixa">Press√£o Caixa (bar):</label>
      <input type="number" id="pressao-caixa" placeholder="Ex: 3.8" step="0.1">
    </div>

    <div class="area-buttons">
        <button class="area-button" data-area="Raizer">Ir para Raizer</button>
        <button class="area-button" data-area="Caixa">Ir para Caixa</button>
    </div>

    <div class="sides">
      <strong>Lado:</strong>
      <button class="side-btn" data-side="A">A</button>
      <button class="side-btn" data-side="B">B</button>
      <button class="side-btn" data-side="C">C</button>
      <button class="side-btn" data-side="D">D</button>
    </div>

    <h2 id="side-title">Lado A</h2>

    <div class="container" id="valvulas-container">
      </div>

    <div id="pergunta-global-container" class="pergunta-global-container">
      </div>

    <div id="confirmar-container">
      <button id="btn-reset">Resetar Lado</button>
      <button id="btn-confirmar">Confirmar Registro</button>
    </div>

    <div id="modal-perfil" class="modal">
      <div class="modal-content">
        <h3>Complete seu perfil</h3>
        <input type="text" id="perfil-nome" placeholder="Nome Completo" required>
        <input type="password" id="perfil-senha" placeholder="Criar Senha (opcional)">
        <button id="btn-salvar-perfil">Salvar Perfil</button>
      </div>
    </div>

    <div id="modal-reset" class="modal">
      <div class="modal-content">
        <h3>Tem certeza que deseja resetar as notas deste lado?</h3>
        <div>
          <button id="btn-sim-resetar">Sim</button>
          <button id="btn-nao-resetar">N√£o</button>
        </div>
      </div>
    </div>

    <div id="modal-confirmacao-geral" class="modal">
      <div class="modal-content">
        <h3>Confirmar registro das notas?</h3>
        <div>
          <button id="btn-sim-confirmar">Sim</button>
          <button id="btn-nao-confirmar">N√£o</button>
        </div>
      </div>
    </div>

    <div id="modal-confirmacao" class="modal">
      <div class="modal-content">
        <h3>Registro Conclu√≠do!</h3>
        <pre id="resumo-text-modal" class="resumo-text"></pre>
        <button id="btn-fechar-modal">Fechar</button>
        <button id="btn-download-modal">Baixar Resumo</button>
      </div>
    </div>
  </div>

  <div id="graph-view" class="view">
    <h1>Op√ß√µes de Gr√°fico</h1>

    <div class="top-bar">
      <button onclick="showBarChart()">Ver Gr√°fico em Barra</button>
      <button onclick="showView('statistics-view'); initStatisticsView();">Ver Estat√≠sticas de V√°lvulas</button>
      <button onclick="showView('valve-view')">üîô Voltar para v√°lvulas</button>
    </div>

    <div id="bar-chart-container">
        <h2>Gr√°fico de Sujeira por Lado</h2>
        <div class="top-bar">
            <button class="side-btn-graph" data-side-graph="A">Lado A</button>
            <button class="side-btn-graph" data-side-graph="B">Lado B</button>
            <button class="side-btn-graph" data-side-graph="C">Lado C</button>
            <button class="side-btn-graph" data-side-graph="D">Lado D</button>
            <select id="periodo-select">
                <option value="7">√öltimos 7 dias</option>
                <option value="30">√öltimos 30 dias</option>
            </select>
            <button onclick="baixarGrafico()">‚¨áÔ∏è Baixar Gr√°fico</button>
        </div>
        <canvas id="grafico-valvulas"></canvas>
    </div>
  </div>

  <div id="statistics-view" class="view">
    <div class="top-bar">
        <button onclick="showView('valve-view')">üîô Voltar para v√°lvulas</button>
        <h2>Estat√≠sticas de V√°lvulas</h2>
        <select id="statistics-periodo-select"> <option value="7">√öltimos 7 dias</option>
            <option value="30">√öltimos 30 dias</option>
            <option value="all">Todo Per√≠odo</option> </select>
        <button onclick="baixarStatisticsGrafico()">‚¨áÔ∏è Baixar Gr√°fico</button>
    </div>

    <div class="area-buttons">
        <button class="area-button" data-area="Raizer">Raizer</button>
        <button class="area-button" data-area="Caixa">Caixa</button>
    </div>

    <div class="sides">
        <strong>Lado:</strong>
        <button class="side-btn" data-side="A">A</button>
        <button class="side-btn" data-side="B">B</button>
        <button class="side-btn" data-side="C">C</button>
        <button class="side-btn" data-side="D">D</button>
    </div>

    <h2 id="statistics-side-title">Selecione uma V√°lvula do Lado A</h2>

    <div class="valvulas-list" id="valvulas-statistics-container">
        </div>

    <div class="chart-container">
        <canvas id="grafico-sujeira-valvula"></canvas>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="auth.js"></script>
  <script src="script.js"></script>
  <script src="statistics.js"></script> <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAJ1_vq5j-Aa6JOXEvUYMxr10lTuCfdTMQ",
      authDomain: "valvulas-ed105.firebaseapp.com",
      projectId: "valvulas-ed105",
      storageBucket: "valvulas-ed105.appspot.com",
      messagingSenderId: "152027783297",
      appId: "1:152027783297:web:474885a8874c0184202d80"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Vari√°veis e fun√ß√µes relacionadas ao Chart.js (Gr√°fico de Barras)
    let ladoAtualGrafico = 'A';
    // Adicionado vari√°vel para a √°rea do gr√°fico de barras
    let areaAtualGrafico = 'Raizer';

    const ctx = document.getElementById('grafico-valvulas').getContext('2d');
    let grafico = null;

    function formatarData(iso) {
      const d = new Date(iso);
      // Para exibir a data no formato DD/MM/AAAA
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = String(d.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa do 0
      const ano = d.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    async function gerarGrafico() {
      const dias = parseInt(document.getElementById('periodo-select').value);
      const agora = new Date();
      // Ajuste para garantir que o limite de data inclua o dia atual
      const limite = new Date(agora.getTime() - dias * 86400000);
      limite.setHours(0, 0, 0, 0); // Zera a hora para pegar desde o in√≠cio do dia
      const limiteISO = limite.toISOString();

      const snapshot = await db.collection('registros')
        .where('data', '>=', limiteISO)
        .where('lado', '==', ladoAtualGrafico)
        .where('area', '==', areaAtualGrafico) // Adicionado filtro por √°rea
        .get();

      const ocorrencias = {};
      snapshot.forEach(doc => {
        const valvulas = doc.data().valvulas || {};
        const data = formatarData(doc.data().data);
        for (const [nome, nota] of Object.entries(valvulas)) {
          const n = parseInt(nota);
          if (n >= 4) {
            if (!ocorrencias[nome]) ocorrencias[nome] = [];
            ocorrencias[nome].push(`Nota: ${n} - Dia ${data}`);
          }
        }
      });

      const labels = Object.keys(ocorrencias).sort();
      const dados = labels.map(label => ocorrencias[label].length);
      const tooltips = labels.map(label => ocorrencias[label].join("\n")); // Use \n para quebra de linha

      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.length ? labels : ['Nenhum dado'],
          datasets: [{
            label: `Notas 4 ou 5 - ${areaAtualGrafico} - Lado ${ladoAtualGrafico}`,
            data: labels.length ? dados : [0],
            backgroundColor: '#ff4d4d'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const idx = context.dataIndex;
                  return tooltips[idx] || 'Sem detalhes';
                }
              },
              // Permite quebra de linha nos tooltips
              bodyFont: {
                size: 14
              },
              footerFont: {
                size: 14
              },
              titleFont: {
                size: 14
              }
            },
            title: {
              display: true,
              text: `V√°lvulas mais sujas (notas 4 ou 5) - ${areaAtualGrafico} - Lado ${ladoAtualGrafico} (${dias} dias)`,
              font: {
                size: 18
              }
            },
            legend: { display: false }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'V√°lvula',
                font: {
                  size: 16
                }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Ocorr√™ncias',
                font: {
                  size: 16
                }
              },
              beginAtZero: true
            }
          }
        }
      });
    }

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de lado (visualiza√ß√£o de v√°lvulas)
    function updateActiveSideButtonValveView() {
      document.querySelectorAll('#valve-view .sides .side-btn').forEach(btn => {
        if (btn.dataset.side === currentSide) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de √°rea (visualiza√ß√£o de v√°lvulas)
    function updateActiveAreaButtonValveView() {
      document.querySelectorAll('#valve-view .area-button').forEach(btn => {
        if (btn.dataset.area === currentArea) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      // Atualiza o campo de input da √°rea
      document.getElementById('input-area').value = currentArea;
    }


    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de lado (visualiza√ß√£o de gr√°fico de barras)
    function updateActiveSideButtonGraphView() {
      document.querySelectorAll('#graph-view .top-bar .side-btn-graph').forEach(btn => {
        if (btn.dataset.sideGraph === ladoAtualGrafico) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de √°rea (visualiza√ß√£o de gr√°fico de barras)
    function updateActiveAreaButtonGraphView() {
        // Atualmente n√£o temos bot√µes de √°rea dedicados na graph-view,
        // mas se for adicionado no futuro, esta fun√ß√£o seria usada.
        // Para o gr√°fico de barras, a √°rea √© implicitamente definida por `areaAtualGrafico`.
        // Se houver bot√µes de √°rea para o gr√°fico de barras, descomente e adapte.
    }


    // Fun√ß√£o para selecionar o lado no gr√°fico de barras e gerar o gr√°fico
    function selecionarLadoGrafico(lado) {
      ladoAtualGrafico = lado;
      updateActiveSideButtonGraphView(); // Atualiza a classe ativa para os bot√µes de lado do gr√°fico
      gerarGrafico();
    }

    // Fun√ß√£o para selecionar a √°rea no gr√°fico de barras e gerar o gr√°fico
    function selecionarAreaGrafico(area) {
        areaAtualGrafico = area;
        // N√£o h√° bot√µes de √°rea para atualizar na graph-view como nos lados,
        // ent√£o apenas chama gerarGrafico.
        gerarGrafico();
    }


    function baixarGrafico() {
      const link = document.createElement('a');
      link.download = `grafico_valvulas_barras_${areaAtualGrafico}_${ladoAtualGrafico}.png`;
      link.href = document.getElementById('grafico-valvulas').toDataURL('image/png');
      link.click();
    }

    function baixarStatisticsGrafico() {
      const link = document.createElement('a');
      link.download = `grafico_estatisticas_${currentStatisticsArea}_${currentStatisticsSide}_${currentSelectedValve}.png`;
      link.href = document.getElementById('grafico-sujeira-valvula').toDataURL('image/png');
      link.click();
    }

    function showGraphOptions() {
        showView('graph-view');
        document.getElementById('bar-chart-container').style.display = 'none'; // Hide bar chart initially
    }

    function showBarChart() {
        document.getElementById('bar-chart-container').style.display = 'block'; // Show bar chart
        selecionarLadoGrafico('A'); // Load default side A chart
    }


    // Adiciona listener para os bot√µes de lado da visualiza√ß√£o de v√°lvulas
    document.querySelectorAll('#valve-view .sides .side-btn').forEach(btn => {
      btn.onclick = () => {
        currentSide = btn.dataset.side;
        initValves();
        updateActiveSideButtonValveView(); // Atualiza a classe ativa para os bot√µes de lado das v√°lvulas
      };
    });

    // Adiciona listener para os bot√µes de √°rea da visualiza√ß√£o de v√°lvulas
    document.querySelectorAll('#valve-view .area-button').forEach(btn => {
        btn.onclick = () => {
            currentArea = btn.dataset.area;
            initValves(); // Re-inicializa as v√°lvulas para a nova √°rea
            updateActiveAreaButtonValveView(); // Atualiza a classe ativa para os bot√µes de √°rea
        };
    });


    // Inicializa a visualiza√ß√£o do gr√°fico quando o app carrega, se o usu√°rio j√° estiver logado
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            startApp(); // De script.js, mostra valve-view
            // Inicializa o bot√£o de lado ativo para a visualiza√ß√£o de v√°lvulas
            updateActiveSideButtonValveView();
            // Inicializa o bot√£o de √°rea ativo para a visualiza√ß√£o de v√°lvulas
            updateActiveAreaButtonValveView();
            // Do not call seleccionarLadoGrafico('A') here, it will be called when 'Ver Gr√°fico em Barra' is clicked
        } else {
            showView('login-view');
        }
    });

    document.getElementById('periodo-select').addEventListener('change', gerarGrafico);

    // Adiciona listeners para os bot√µes de lado do gr√°fico de barras
    document.querySelectorAll('#graph-view .side-btn-graph').forEach(btn => {
        btn.addEventListener('click', () => {
            selecionarLadoGrafico(btn.dataset.sideGraph);
        });
    });

  </script>
</body>
</html>